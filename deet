#!/usr/bin/env bash


rebuild_pkg()
{
    filepath=$1

    cd $build_dir
    base=$(echo $filepath | rev | cut -d '/' -f 1 | rev)

    echo "Downloading PKGBUILD for <$base>"

    $(deet-pkgbuild $base 2&>>$deet_log)
    if [[ $? -ne 0 ]]
    then
        echo Python get_pkgbuild_files.py failed! Check deet.log
        exit 1;
    fi

    $(makepkg -is --noconfirm 2&>>deet_log)
    if [[ $? -ne 0 ]]
    then
        echo Makepkg failed! Check deet.log
        exit 1;
    fi

    $(rm -r *)
    cd ..

    create_debug_file $filepath
}

create_debug_file()
{
    exepath=$1
    base=$(echo $exepath | rev | cut -d '/' -f 1 | rev)

    debugfile=$base.debug

    echo "creating debug file for $exepath [$debugfile]"
    $(objcopy --only-keep-debug $exepath $debugfile)
    echo "Stripping $exepath...."
    $(strip --strip-all $exepath)
    echo "adding gnu-debuglink $debugfile"
    $(objcopy --add-gnu-debuglink=$debugfile $exepath)
    $(gzip $debugfile)

    if [[ -d $deet_db/$base ]]
    then
        $(mkdir $deet_db/$base)
    fi

    $(mv $debugfile.gz $deet_db/$base)
    $(date +%s > $deet_db/timestamp)
}

parse_file()
{
    filepath=$1

    file_output=$(file $filepath)

    if [[ $file_output =~ "with debug" ]]
    then
        echo "<$filepath>....is *not* stripped"
        create_debug_file $filepath
    elif [[ $file_output =~ "stripped" ]]
    then
        echo "<$filepath>....is stripped"
        rebuild_pkg $filepath
    else
        echo "<$filepath>....is not a binary\n"
    fi
}

is_path_or_file()
{

    link=$1
    if [[ $link =~ "/" ]]
    then
        echo Following symlink...$link
        check_pkg_path $link;
    else
        echo Following symlink.../usr/bin/$link
        check_pkg_file $link;
    fi
}

check_pkg_path()
{
    pkg_path=$1

    if [[ -x $pkg_path ]]
    then
        parse_file $pkg_path;
    fi
}

check_pkg_file()
{
    pkg=$1

    if [[ ! -d $build_dir ]]
    then
        $(mkdir $build_dir)
    fi

    # add check on posix script files
    if [[ -h /usr/bin/$pkg ]]
    then
        exepath=$(readlink /usr/bin/$pkg);
        is_path_or_file $exepath;
    elif [[ -x /usr/bin/$pkg ]]
    then
        parse_file "/usr/bin/$pkg";
    elif [[ ! -f /usr/bin/$pkg ]]
    then
        echo Invalid filename
        exit 1
    fi
}

pac_query()
{
    echo "[[ Initializing pacman package database query.... ]]";

    for pkg in $(pacman -Qnq)
    do
        if [[ -a /usr/bin/$pkg ]]
        then
            echo "[Package :: <$pkg>]";
            echo "Checking pkg binary...";
            check_pkg_file $pkg;
        fi
    done

    echo "[[ Query complete ]]";
}

deploy_debug()
{
    pkg=$1

    if [[ ! -d $debug_dir ]]
    then
        $(mkdir $debug_dir)
    fi

    for debug in $(ls $deet_db)
    do
        if [[ $debug =~ $pkg ]]
        then
            echo Decompressing $debug
            $(gunzip $deet_db/$debug)
            echo Making $pkg.debug available in $debug_dir
            $(cp $deet_db/$pkg.debug $debug_dir)
            $(gzip $deet_db/$pkg.debug)
            echo $pkg symbols now available
        fi

        exit 0
    done

    echo $pkg no debug file found!
}

build_dir="/tmp/DEET/build_dir"
debug_dir="/usr/bin/.debug"

deet_db="/var/lib/DEET"
deet_log="/var/log/deet.log"

if [[ ! -d $deet_db ]]
then
    $(mkdir $deet_db)
fi

while getopts "ad:p:" opts
do
    case $opts in

    a)
        pac_query
        ;;
    d)
        deploy_debug $OPTARG
        ;;
    p)
        check_pkg_file $OPTARG
        ;;
    ?)
        echo Invalid Option
        exit 1
    esac
done

if [[ -d $build_dir ]]
then
    $(rm -r $build_dir)
fi

